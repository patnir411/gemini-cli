<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini CLI - Tools System Architecture</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; padding: 40px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .back-link { display: inline-block; margin-bottom: 20px; padding: 10px 20px; background: #4285f4; color: white; text-decoration: none; border-radius: 6px; }
        h1 { color: #4285f4; margin-bottom: 20px; }
        h2 { color: #4285f4; margin-top: 40px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
        h3 { color: #34a853; margin-top: 25px; margin-bottom: 15px; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em; color: #d32f2f; }
        pre { background: #f5f5f5; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 20px 0; border-left: 4px solid #4285f4; }
        pre code { background: none; color: #333; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: left; }
        th { background: #f5f5f5; color: #4285f4; font-weight: 600; }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px; margin: 20px 0; border-radius: 6px; }
        .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0; border-radius: 6px; }
        ul, ol { margin: 15px 0 15px 40px; }
        li { margin: 8px 0; }
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .tool-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; background: #fafafa; }
        .tool-card h4 { color: #4285f4; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">‚Üê Back to Index</a>

        <h1>üõ†Ô∏è Tools System Architecture</h1>
        <p style="font-size: 1.1em; color: #666; margin-bottom: 30px;">
            Deep dive into Gemini CLI's extensible tool system and execution framework
        </p>

        <h2>üéØ Overview</h2>
        <p>
            The tools system is the backbone of Gemini CLI's agent capabilities. It enables the AI model
            to perform actions in the real world - reading files, executing commands, searching codebases,
            and interfacing with external services.
        </p>

        <div class="info-box">
            <strong>Key Concepts:</strong>
            <ul>
                <li><strong>Tool:</strong> A function the AI can call with parameters and receive results</li>
                <li><strong>Tool Registry:</strong> Central repository of all available tools</li>
                <li><strong>Tool Scheduler:</strong> Orchestrates tool execution with confirmations</li>
                <li><strong>Policy Engine:</strong> Enforces security policies for tool use</li>
                <li><strong>Tool Types:</strong> Built-in, MCP, Discovered, Extension</li>
            </ul>
        </div>

        <h2>üìã Tool Registry</h2>
        <p>File: <code>packages/core/src/tools/tool-registry.ts</code></p>

        <h3>Architecture</h3>
        <pre><code>class ToolRegistry {
  private tools: Map<string, ToolBuilder>
  private mcpTools: Map<string, DiscoveredMCPTool>
  private discoveredTools: Map<string, DiscoveredTool>

  registerTool(name: string, builder: ToolBuilder): void
  getTool(name: string): ToolBuilder | undefined
  getAllTools(): ToolBuilder[]
  getToolsForDeclaration(): FunctionDeclaration[]
}</code></pre>

        <h3>Tool Sources</h3>
        <table>
            <tr>
                <th>Source</th>
                <th>Loading Method</th>
                <th>File Location</th>
            </tr>
            <tr>
                <td><strong>Built-in Tools</strong></td>
                <td>Hardcoded registration</td>
                <td><code>packages/core/src/tools/*.ts</code></td>
            </tr>
            <tr>
                <td><strong>MCP Tools</strong></td>
                <td>Dynamic discovery from MCP servers</td>
                <td>Via <code>mcp-client-manager.ts</code></td>
            </tr>
            <tr>
                <td><strong>Discovered Tools</strong></td>
                <td>TOML command files</td>
                <td><code>.gemini/commands/**/*.toml</code></td>
            </tr>
            <tr>
                <td><strong>Extension Tools</strong></td>
                <td>Extension-provided MCP servers</td>
                <td>Extension directories</td>
            </tr>
        </table>

        <h2>üîß Built-in Tools</h2>

        <div class="tool-grid">
            <div class="tool-card">
                <h4>üìñ Read</h4>
                <p><strong>File:</strong> <code>tools/read-file.ts</code></p>
                <p>Reads file contents with encoding detection, line limits, and binary file handling</p>
                <p><strong>Params:</strong> <code>file_paths[]</code>, <code>limit</code>, <code>offset</code></p>
            </div>

            <div class="tool-card">
                <h4>‚úçÔ∏è Write</h4>
                <p><strong>File:</strong> <code>tools/write-file.ts</code></p>
                <p>Creates or overwrites files with content</p>
                <p><strong>Params:</strong> <code>file_path</code>, <code>content</code></p>
            </div>

            <div class="tool-card">
                <h4>‚úèÔ∏è Edit</h4>
                <p><strong>File:</strong> <code>tools/edit-file.ts</code></p>
                <p>Performs exact string replacement in files</p>
                <p><strong>Params:</strong> <code>file_path</code>, <code>old_string</code>, <code>new_string</code>, <code>replace_all</code></p>
            </div>

            <div class="tool-card">
                <h4>üñ•Ô∏è Shell</h4>
                <p><strong>File:</strong> <code>tools/shell.ts</code></p>
                <p>Executes shell commands with streaming output</p>
                <p><strong>Params:</strong> <code>command</code>, <code>timeout</code>, <code>run_in_background</code></p>
            </div>

            <div class="tool-card">
                <h4>üîç Grep</h4>
                <p><strong>File:</strong> <code>tools/grep.ts</code></p>
                <p>Searches file contents using ripgrep</p>
                <p><strong>Params:</strong> <code>pattern</code>, <code>path</code>, <code>output_mode</code>, <code>multiline</code></p>
            </div>

            <div class="tool-card">
                <h4>üìÅ Glob</h4>
                <p><strong>File:</strong> <code>tools/glob.ts</code></p>
                <p>Finds files matching glob patterns</p>
                <p><strong>Params:</strong> <code>pattern</code>, <code>path</code></p>
            </div>

            <div class="tool-card">
                <h4>üåê WebFetch</h4>
                <p><strong>File:</strong> <code>tools/web-fetch.ts</code></p>
                <p>Fetches web content and converts HTML to text</p>
                <p><strong>Params:</strong> <code>urls[]</code>, <code>process_instruction</code></p>
            </div>

            <div class="tool-card">
                <h4>üîé WebSearch</h4>
                <p><strong>File:</strong> <code>tools/web-search.ts</code></p>
                <p>Performs Google Search via Gemini grounding</p>
                <p><strong>Params:</strong> <code>query</code></p>
            </div>

            <div class="tool-card">
                <h4>üìù Todo</h4>
                <p><strong>File:</strong> <code>tools/todo.ts</code></p>
                <p>Manages task lists displayed in UI</p>
                <p><strong>Params:</strong> <code>todos[]</code></p>
            </div>

            <div class="tool-card">
                <h4>üîß Git</h4>
                <p><strong>File:</strong> <code>tools/git.ts</code></p>
                <p>Executes git commands with safety checks</p>
                <p><strong>Params:</strong> <code>command</code></p>
            </div>

            <div class="tool-card">
                <h4>ü§ñ Subagent</h4>
                <p><strong>File:</strong> <code>tools/subagent.ts</code></p>
                <p>Launches specialized agents for subtasks</p>
                <p><strong>Params:</strong> <code>agent</code>, <code>input</code></p>
            </div>

            <div class="tool-card">
                <h4>üí≠ Memory</h4>
                <p><strong>File:</strong> <code>tools/memory.ts</code></p>
                <p>Stores long-term user preferences</p>
                <p><strong>Params:</strong> <code>content</code></p>
            </div>
        </div>

        <h2>‚öôÔ∏è Tool Execution Flow</h2>

        <h3>1. Tool Invocation Creation</h3>
        <pre><code>// Gemini returns function call
{
  id: "call_abc123",
  name: "Read",
  args: {
    file_paths: ["src/index.ts"],
    limit: 100
  }
}

// Create tool invocation
const invocation = await ToolInvocation.build({
  toolCallId: call.id,
  name: call.name,
  args: call.args,
  toolRegistry,
  workspaceContext
})</code></pre>

        <h3>2. Schema Validation</h3>
        <pre><code>// Validate against JSON schema
const tool = toolRegistry.getTool(name)
const validationError = SchemaValidator.validate(
  tool.inputSchema,
  args
)

if (validationError) {
  return {
    error: `Invalid arguments: ${validationError}`
  }
}</code></pre>

        <h3>3. Policy Check</h3>
        <p>File: <code>packages/core/src/policy/policyEngine.ts</code></p>

        <pre><code>const decision = policyEngine.evaluate({
  action: "tool",
  tool_name: name,
  tool_args: args,
  workspace: workspacePath
})

// Result: ALLOW, DENY, or ASK_USER

if (decision === PolicyDecision.DENY) {
  throw new Error("Tool blocked by policy")
}

if (decision === PolicyDecision.ASK_USER) {
  // Request user confirmation
}</code></pre>

        <h3>4. User Confirmation</h3>
        <pre><code>// Show tool details in UI
yield {
  type: 'TOOL_CONFIRMATION_REQUIRED',
  tool: {
    name: "Write",
    args: { file_path: "/workspace/test.txt", ... },
    description: "Create file test.txt"
  }
}

// Wait for user decision
const approved = await waitForApproval()

if (!approved) {
  return { error: "User rejected tool execution" }
}</code></pre>

        <h3>5. Execution</h3>
        <pre><code>// Execute with abort signal
const result = await tool.execute(args, {
  signal: abortSignal,
  workspace: workspaceContext,
  outputStream: (chunk) => {
    // Stream output to UI in real-time
  }
})

// Result structure
{
  output: "Successfully wrote 42 bytes to /workspace/test.txt",
  metadata: { bytesWritten: 42 }
}</code></pre>

        <h3>6. Result Processing</h3>
        <pre><code>// Truncate large outputs
if (output.length > 10000) {
  const tempFile = writeTempFile(output)
  output = `[Output truncated - saved to ${tempFile}]\n` +
           output.substring(0, 1000)
}

// Format for Gemini API
return {
  functionResponse: {
    id: toolCallId,
    name: toolName,
    response: {
      output: output
    }
  }
}</code></pre>

        <h2>üîê Policy Engine</h2>

        <h3>Policy File Format (TOML)</h3>
        <pre><code>[policies.allow_edit_trusted_files]
tier = "user"
priority = 100
condition.action = "tool"
condition.tool_name = "Edit"
condition.tool_args.file_path = "{{ workspace }}/**"
decision = "ALLOW"

[policies.deny_shell_rm]
tier = "admin"
priority = 200
condition.action = "tool"
condition.tool_name = "Shell"
condition.tool_args.command = "^rm -rf"
decision = "DENY"</code></pre>

        <h3>Policy Tiers</h3>
        <table>
            <tr>
                <th>Tier</th>
                <th>Location</th>
                <th>Priority Range</th>
            </tr>
            <tr>
                <td><strong>default</strong></td>
                <td>Built-in policies</td>
                <td>0 - 999</td>
            </tr>
            <tr>
                <td><strong>user</strong></td>
                <td><code>~/.gemini/policies/</code></td>
                <td>1000 - 1999</td>
            </tr>
            <tr>
                <td><strong>admin</strong></td>
                <td><code>/etc/gemini-cli/policies/</code></td>
                <td>2000 - 2999</td>
            </tr>
        </table>

        <div class="info-box">
            <strong>üí° Policy Evaluation:</strong><br><br>
            Policies are evaluated in order of <strong>tier + priority</strong> (descending).
            The first matching policy determines the decision (ALLOW, DENY, or ASK_USER).
            If no policy matches, the default behavior is ASK_USER.
        </div>

        <h2>üîå MCP Tool Integration</h2>

        <h3>Tool Discovery</h3>
        <pre><code>// Connect to MCP server
const client = new Client({ name: "gemini-cli" })
await client.connect(transport)

// List available tools
const { tools } = await client.listTools()

// Register each tool
for (const tool of tools) {
  toolRegistry.registerMCPTool({
    serverName: "example-server",
    toolName: tool.name,
    schema: tool.inputSchema,
    description: tool.description
  })
}</code></pre>

        <h3>Tool Invocation</h3>
        <pre><code>// Call MCP tool
const result = await mcpClient.callTool(toolName, args)

// Convert MCP response to Gemini format
if (result.content) {
  return convertMcpContentToResponse(result.content)
}

// Handle errors
if (result.isError) {
  return { error: result.content[0].text }
}</code></pre>

        <h2>üé® Tool Customization</h2>

        <h3>Discovered Tools (TOML)</h3>
        <p>File: <code>.gemini/commands/custom-command.toml</code></p>

        <pre><code>[command]
name = "deploy"
description = "Deploy the application"
kind = "shell"

[command.args]
environment = { type = "string", required = true }

[command.action]
shell = """
npm run build
./deploy.sh {{args.environment}}
"""</code></pre>

        <h3>Creating a Custom Tool (TypeScript)</h3>
        <pre><code>import { DeclarativeTool } from './tool-base'

class MyCustomTool extends DeclarativeTool {
  name = "MyTool"
  description = "Does something custom"

  inputSchema = {
    type: "object",
    properties: {
      input: { type: "string" }
    },
    required: ["input"]
  }

  async execute(args: { input: string }) {
    // Your logic here
    const result = await processInput(args.input)

    return {
      output: `Processed: ${result}`
    }
  }
}

// Register
toolRegistry.registerTool("MyTool", new MyCustomTool())</code></pre>

        <h2>üõ°Ô∏è Safety Features</h2>

        <div class="success-box">
            <strong>‚úÖ Built-in Safety Mechanisms:</strong>
            <ul>
                <li><strong>Folder Trust:</strong> Operations outside workspace require explicit trust</li>
                <li><strong>Shell Command Parsing:</strong> Uses tree-sitter to parse and validate shell commands</li>
                <li><strong>Blocklisted Commands:</strong> Dangerous patterns (e.g., <code>rm -rf /</code>) automatically blocked</li>
                <li><strong>Git Checkpointing:</strong> Automatic git snapshots before destructive file operations</li>
                <li><strong>Output Truncation:</strong> Prevents massive outputs from consuming memory</li>
                <li><strong>Timeout Support:</strong> Commands can be time-limited to prevent hangs</li>
                <li><strong>Abort Signal:</strong> All tools support cancellation via AbortSignal</li>
                <li><strong>Sandbox Execution:</strong> Docker/Podman isolation for untrusted workspaces</li>
            </ul>
        </div>

        <h2>üìä Tool Execution Modes</h2>

        <h3>Confirmation Modes</h3>
        <table>
            <tr>
                <th>Mode</th>
                <th>Behavior</th>
                <th>Activation</th>
            </tr>
            <tr>
                <td><strong>DEFAULT</strong></td>
                <td>Ask for confirmation on all tools</td>
                <td>Default behavior</td>
            </tr>
            <tr>
                <td><strong>AUTO_EDIT</strong></td>
                <td>Auto-approve Read/Write/Edit only</td>
                <td>Shift+Tab or setting</td>
            </tr>
            <tr>
                <td><strong>YOLO</strong></td>
                <td>Auto-approve all tools</td>
                <td>Ctrl+Y or setting (can be disabled)</td>
            </tr>
        </table>

        <h3>Sandbox Modes</h3>
        <table>
            <tr>
                <th>Mode</th>
                <th>Description</th>
            </tr>
            <tr>
                <td><strong>none</strong></td>
                <td>No sandboxing - tools execute directly on host</td>
            </tr>
            <tr>
                <td><strong>docker</strong></td>
                <td>Executes tools in Docker container</td>
            </tr>
            <tr>
                <td><strong>podman</strong></td>
                <td>Executes tools in Podman container</td>
            </tr>
        </table>

        <h2>üéØ Advanced Features</h2>

        <h3>Tool Output Streaming</h3>
        <pre><code>// Shell tool streams output in real-time
const process = spawn(command, args)

process.stdout.on('data', (chunk) => {
  outputStream?.(chunk.toString())
})

// UI displays output as it arrives
for await (const chunk of toolOutputStream) {
  renderOutput(chunk)
}</code></pre>

        <h3>Background Execution</h3>
        <pre><code>// Run shell command in background
{
  name: "Shell",
  args: {
    command: "npm install",
    run_in_background: true
  }
}

// Returns shell ID for later monitoring
{
  output: "Started background process: shell_abc123"
}

// Monitor output later
const output = await BashOutput({ bash_id: "shell_abc123" })</code></pre>

        <h3>Tool Allowlists & Exclusions</h3>
        <p>In settings:</p>
        <pre><code>{
  "tools": {
    "allowed": ["Read", "Write", "Grep"],  // Only these allowed
    "exclude": ["Shell"],  // Never include this tool
    "core": {  // Built-in tools specifically
      "allowed": ["Read", "Grep"]
    }
  }
}</code></pre>

        <div style="margin-top: 40px; text-align: center;">
            <a href="../index.html" class="back-link">‚Üê Back to Index</a>
        </div>
    </div>
</body>
</html>
